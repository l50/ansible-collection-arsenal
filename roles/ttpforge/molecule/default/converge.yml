---
- name: Converge
  hosts: all
  tasks:
    - name: Include default variables
      ansible.builtin.include_vars:
        file: "../../defaults/main.yml"
    - name: Include variables
      ansible.builtin.include_vars:
        file: "../../vars/main.yml"
  vars:
    ttpforge_global_install: true

  roles:
    - name: Create ttpforge role user (if not already present)
      role: cowdogmoo.workstation.user_setup
      vars:
        user_setup_default_users: "{{ ttpforge_users }}"

    - name: Install asdf and go
      role: cowdogmoo.workstation.asdf
      vars:
        asdf_global_install: "{{ ttpforge_global_install | default(false) }}"

    - name: Run the ttpforge role
      role: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') | basename }}"
      environment:
        ASDF_DATA_DIR: /opt/asdf
        ASDF_DIR: /opt/asdf
      vars:
        ttpforge_go_path: /opt/asdf/shims/go
        ttpforge_install_path: /usr/local/bin/ttpforge
        ttpforge_repo_path: /opt/ttpforge
        ttpforge_global_install: true
