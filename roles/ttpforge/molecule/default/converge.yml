---
- name: Converge
  hosts: all
  vars:
    ttpforge_users:
      - username: ttpforge
        usergroup: ttpforge
        shell: "/bin/bash"
        sudo: true
        plugins:
          - name: golang
            version: "1.22.0"
            scope: "global"

  tasks:
    - name: Include default variables
      ansible.builtin.include_vars:
        file: "../../defaults/main.yml"
    - name: Include variables
      ansible.builtin.include_vars:
        file: "../../vars/main.yml"

  roles:
    - name: Create ttpforge role test user
      role: cowdogmoo.workstation.user_setup
      vars:
        user_setup_default_users: "{{ ttpforge_users }}"

    - name: Install asdf and go
      role: cowdogmoo.workstation.asdf
      vars:
        asdf_global_install: true
        asdf_users: "{{ ttpforge_users }}"

    - name: Run the ttpforge role
      role: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') | basename }}"
      environment:
        ASDF_DATA_DIR: /opt/asdf
        ASDF_DIR: /opt/asdf
      vars:
        ttpforge_go_path: /opt/asdf/shims/go
