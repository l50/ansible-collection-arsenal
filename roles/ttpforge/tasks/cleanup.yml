---
- name: Create list of packages to protect
  ansible.builtin.set_fact:
    ttpforge_protected_packages: "{{ (ttpforge_packages.essential | default([])) + (ttpforge_packages.runtime_debian | default([])) + ['python3', 'python3-minimal', 'libpython3-stdlib', 'python3-apt'] | unique }}"
  when: ansible_os_family == "Debian"

- name: Hold runtime and essential packages before cleanup
  ansible.builtin.dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop: "{{ ttpforge_protected_packages }}"
  become: true
  when:
    - ansible_os_family == "Debian"
  failed_when: false

- name: Remove build-time Go installation and caches
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ ttpforge_cleanup_paths }}"
  become: true

- name: Find non-binary files in ttpforge directory
  ansible.builtin.find:
    paths: "{{ ttpforge_install_path }}"
    file_type: file
    recurse: false
    excludes: "{{ ttpforge_keep_binaries }}"
  register: ttpforge_files_to_remove
  become: true

- name: Remove non-binary files from ttpforge directory
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ ttpforge_files_to_remove.files }}"
  become: true

- name: Remove source directories from ttpforge installation
  ansible.builtin.file:
    path: "{{ ttpforge_install_path }}/{{ item }}"
    state: absent
  loop: "{{ ttpforge_source_directories }}"
  become: true

- name: Find empty directories in ttpforge path
  ansible.builtin.find:
    paths: "{{ ttpforge_install_path }}"
    file_type: directory
    recurse: true
  register: ttpforge_all_dirs
  become: true

- name: Remove empty directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ ttpforge_all_dirs.files }}"
  when: item.size == 0
  become: true

- name: Strip debug symbols from binary
  ansible.builtin.command:
    cmd: "strip {{ ttpforge_install_path }}/{{ item }}"
  loop: "{{ ttpforge_keep_binaries }}"
  become: true
  changed_when: false
  failed_when: false

- name: Remove ASDF version manager
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/local/bin/asdf
    - /opt/asdf
    - "{{ ttpforge_user_home }}/.asdf"
  become: true

- name: Gather package facts
  ansible.builtin.package_facts:
    manager: apt
  when: ansible_os_family == "Debian"
  become: true

- name: Remove development packages (excluding protected)
  ansible.builtin.apt:
    name: "{{ ttpforge_cleanup_packages_debian }}"
    state: absent
    purge: true
    autoremove: true
  when: ansible_os_family == "Debian"
  become: true
  failed_when: false

- name: Clean all cache directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ (ttpforge_cleanup_paths + ttpforge_additional_cleanup_paths | default([])) | unique }}"
  become: true
  failed_when: false  # Continue even if some paths don't exist

- name: Verify ttpforge binary still works after cleanup
  ansible.builtin.command:
    cmd: "{{ ttpforge_install_path }}/{{ item }} --version"
  loop: "{{ ttpforge_keep_binaries }}"
  register: ttpforge_binary_check
  failed_when: false
  become: true
  changed_when: false

- name: Find and remove Python artifacts efficiently
  ansible.builtin.shell: |
    set -o pipefail
    # Target specific Python paths but keep core Python
    for dir in /usr/lib/python* /usr/local/lib/python*; do
      if [ -d "$dir" ]; then
        find "$dir" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
        find "$dir" -type f \( -name "*.pyc" -o -name "*.pyo" \) -delete 2>/dev/null || true
        # Remove test directories but keep core modules
        find "$dir" -type d \( -name "test" -o -name "tests" -o -name "idle_test" \) -exec rm -rf {} + 2>/dev/null || true
      fi
    done
    # Remove pip cache
    rm -rf /root/.cache/pip
    rm -rf /home/*/.cache/pip
  args:
    executable: /bin/bash
  become: true
  changed_when: false
  failed_when: false

- name: Truncate log files
  ansible.builtin.shell: |
    find /var/log -type f -exec truncate -s 0 {} \; 2>/dev/null || true
  args:
    executable: /bin/bash
  become: true
  changed_when: false
  failed_when: false

- name: Container-specific optimizations
  when: ansible_virtualization_type == "docker"
  block:
    - name: Remove container-unnecessary locale data
      ansible.builtin.shell: |
        # Keep only C and en_US locales
        find /usr/share/locale -mindepth 1 -maxdepth 1 ! -name 'en*' -exec rm -rf {} + 2>/dev/null || true
        # Remove large locale source files
        rm -rf /usr/share/i18n/locales/cns11643_stroke
        rm -rf /usr/share/i18n/locales/iso14651_t1_common
        find /usr/share/i18n -type f -size +1M -delete 2>/dev/null || true
      args:
        executable: /bin/bash
      become: true
      changed_when: false
      failed_when: false

    - name: Remove container-unnecessary system files
      ansible.builtin.shell: |
        rm -rf /usr/share/zoneinfo
        rm -rf /usr/share/doc
        rm -rf /usr/share/man
        rm -rf /usr/share/info
        rm -rf /var/cache/ldconfig
      args:
        executable: /bin/bash
      become: true
      failed_when: false
      changed_when: false  # These are cleanup operations, not changes

- name: Targeted cleanup for TTPForge container
  ansible.builtin.shell: |
    set -o pipefail
    echo "=== Starting targeted cleanup for TTPForge container ==="

    # Always protect Python3 for Ansible
    PYTHON_PROTECTED="python3 python3-minimal libpython3-stdlib python3-apt"

    # Remove Python 3.14.0 installed via ASDF (not needed by TTPForge)
    rm -rf {{ ttpforge_user_home }}/.asdf/installs/python

    # Remove graphics and display libraries
    apt-get remove -y --purge \
      {{ ttpforge_container_remove_packages | join(' ') }} \
      libllvm* llvm* \
      libgl* libgles* libdrm* mesa* \
      libgtk* libgdk* \
      libasound* libpulse* \
      libx11-* libxext* libxrender* libxtst* \
      2>/dev/null || true

    # Remove snapd
    apt-get remove -y --purge snapd snap-confine ubuntu-core-launcher 2>/dev/null || true
    rm -rf /usr/lib/snapd /snap /var/snap /var/lib/snapd

    # Remove development tools (but not runtime libraries)
    apt-get remove -y --purge \
      *-dev *-dbg *-doc \
      gcc* g++* cpp* \
      libtool cmake dpkg-dev \
      linux-libc-dev libc6-dev libc-dev-bin \
      manpages manpages-dev \
      2>/dev/null || true

    # Remove hardware databases
    rm -rf /usr/lib/udev
    rm -f /lib/udev/hwdb.bin

    # Remove gconv libraries if not needed
    rm -rf /usr/lib/*/gconv

    # Remove static libraries and headers
    find /usr -name "*.a" -delete 2>/dev/null || true
    find /usr -name "*.la" -delete 2>/dev/null || true
    rm -rf /usr/include

    # Final autoremove
    apt-get autoremove -y --purge

    echo "=== Targeted cleanup complete ==="
  args:
    executable: /bin/bash
  become: true
  when: ansible_os_family == "Debian"
  failed_when: false
  changed_when: false

- name: Final APT cleanup
  ansible.builtin.apt:
    autoclean: yes
    autoremove: yes
    clean: yes
  become: true
  when: ansible_os_family == "Debian"
  changed_when: false
  failed_when: false

- name: Clean APT cache and lists
  ansible.builtin.shell: |
    rm -rf /var/lib/apt/lists/*
    rm -rf /var/cache/apt/*
    rm -rf /var/lib/dpkg/*-old
    rm -rf /var/lib/dpkg/backup/*
  args:
    executable: /bin/bash
  become: true
  when: ansible_os_family == "Debian"
  changed_when: false

- name: Unhold protected packages after cleanup
  ansible.builtin.shell: |
    set -o pipefail
    for pkg in {{ ttpforge_protected_packages | join(' ') }}; do
      echo "$pkg install" | dpkg --set-selections 2>/dev/null || true
    done
  args:
    executable: /bin/bash
  become: true
  when: ansible_os_family == "Debian"
  failed_when: false
  changed_when: false  # This is a state restoration, not a change

- name: Display cleanup summary
  ansible.builtin.debug:
    msg:
      - "=== TTPForge Cleanup Complete ==="
      - "Protected packages: {{ ttpforge_protected_packages | length }}"
      - "Binary verified: {{ ttpforge_keep_binaries | join(', ') }}"
      - "Binary functional: {{ ttpforge_binary_check.results | selectattr('rc', 'equalto', 0) | list | length == ttpforge_keep_binaries | length }}"
  when: ttpforge_binary_check is defined
